name: ‚Ü©Ô∏è Restauration √† partir de la derni√®re sauvegarde

on:
  workflow_dispatch:
    # Permet de d√©clencher le workflow manuellement

jobs:
  restore:
    runs-on: ubuntu-latest
    permissions: # <-- CORRECTION DE LA PERMISSION
      contents: write # Accorde la permission d'√©crire au jeton GITHUB_TOKEN
      
    steps:
      - name: ‚¨áÔ∏è Checkout du code
        uses: actions/checkout@v4

      - name: üîç Trouver la derni√®re sauvegarde
        id: find_latest
        run: |
          # Trie les dossiers de sauvegarde par date (le plus r√©cent en premier) et prend le premier
          LATEST_BACKUP=$(ls -td saves/backup-* | head -1)
          
          if [ -z "$LATEST_BACKUP" ]; then
            echo "::error::Aucune sauvegarde trouv√©e dans 'saves/'."
            exit 1
          fi
          
          echo "Derni√®re sauvegarde trouv√©e : $LATEST_BACKUP"
          echo "RESTORE_DIR=$LATEST_BACKUP" >> $GITHUB_OUTPUT

      - name: üóëÔ∏è Nettoyer la racine actuelle
        run: |
          # Liste tous les fichiers et dossiers √† la racine (sauf . et ..)
          # et les filtre pour exclure les dossiers de travail.
          
          # La commande suivante supprime tous les fichiers/dossiers de la racine
          # EXCEPTE les √©l√©ments list√©s.
          ls -A | grep -v -E "^\.(git|github)$|^saves$|^dev$" | xargs rm -rf

      - name: üì• Restaurer les fichiers
        run: |
          RESTORE_DIR="${{ steps.find_latest.outputs.RESTORE_DIR }}"
          
          if [ ! -d "$RESTORE_DIR" ]; then
            echo "::error::Le r√©pertoire de sauvegarde '$RESTORE_DIR' n'existe pas."
            exit 1
          fi
          
          # Copie le CONTENU de la sauvegarde vers la racine (cp -r ne supprime rien)
          cp -r "$RESTORE_DIR"/* .
          
          echo "Restauration effectu√©e √† partir de $RESTORE_DIR"

      - name: üíæ Commit et Push de la restauration
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add .
          
          # V√©rifie si il y a des changements avant de commiter
          if git diff --staged --quiet; then
            echo "Pas de changements √† commiter."
          else
            RESTORE_DIR="${{ steps.find_latest.outputs.RESTORE_DIR }}"
            git commit -m "ü§ñ Auto-restauration: Annulation du d√©ploiement avec la sauvegarde $RESTORE_DIR"
            git push
          fi
          
      - name: üöÄ D√©ploiement Final du Site Statique
        # Cette action va explicitement dire √† GitHub de mettre √† jour les Pages
        uses: actions/deploy-pages@v4 
        # C'est l'action standard et recommand√©e pour le d√©ploiement de Pages.
        
        # Le 'needs: commit' assure que l'action ne se lance que si la restauration a eu lieu.
        with:
          # Note: Nous ne sp√©cifions pas de chemin 'source' ou 'artifact' car l'action 
          # est configur√©e pour prendre le contenu de la branche 'main' (ou master) 
          # si l'option 'source' est d√©finie sur 'main' dans les param√®tres de Pages.
          # L'action utilise le jeton de Pages pour d√©clencher la mise √† jour.
          pass-metadata: true 
