name: ‚Ü©Ô∏è Restauration √† partir de la derni√®re sauvegarde

on:
  workflow_dispatch:
    # Permet de d√©clencher le workflow manuellement

jobs:
  restore:
    runs-on: ubuntu-latest
    permissions: # <-- CORRECTION DE LA PERMISSION
      contents: write # Accorde la permission d'√©crire au jeton GITHUB_TOKEN
      
    steps:
      - name: ‚¨áÔ∏è Checkout du code
        uses: actions/checkout@v4
        
      - name: üîç Trouver la derni√®re sauvegarde (Archive)
        id: find_latest
        run: |
          # Trouve la derni√®re archive .tar.gz par date
          LATEST_BACKUP=$(ls -td saves/backup-*.tar.gz | head -1)
          
          if [ -z "$LATEST_BACKUP" ]; then
            echo "::error::Aucune archive de sauvegarde trouv√©e dans 'saves/'."
            exit 1
          fi
          
          echo "Derni√®re archive trouv√©e : $LATEST_BACKUP"
          echo "RESTORE_ARCHIVE=$LATEST_BACKUP" >> $GITHUB_OUTPUT

      # L'√©tape de nettoyage de la racine reste la m√™me.

      - name: üì• Restauration et D√©compression des fichiers
        run: |
          RESTORE_ARCHIVE="${{ steps.find_latest.outputs.RESTORE_ARCHIVE }}"
          
          if [ ! -f "$RESTORE_ARCHIVE" ]; then
            echo "::error::L'archive de sauvegarde '$RESTORE_ARCHIVE' n'existe pas."
            exit 1
          fi
          
          # D√©compresse l'archive √† la racine (cette commande extrait les fichiers)
          tar -xzvf "$RESTORE_ARCHIVE" -C .
          
          echo "Restauration effectu√©e √† partir de $RESTORE_ARCHIVE"
