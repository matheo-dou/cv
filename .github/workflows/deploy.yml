name: DÃ©ploiement Statique

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: â¬‡ï¸ Checkout du code
        uses: actions/checkout@v4

      - name: âš™ï¸ PrÃ©paration des dossiers et nom de l'archive
        id: setup
        run: |
          # CrÃ©e le dossier saves s'il n'existe pas
          mkdir -p saves

          # DÃ©finit le nom de l'archive de sauvegarde
          SAVE_ARCHIVE="saves/backup-$(date +%Y%m%d-%H%M%S).tar.gz"
          echo "SAVE_ARCHIVE=$SAVE_ARCHIVE" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ CrÃ©ation et compression de la sauvegarde
        run: |
          SAVE_ARCHIVE="${{ steps.setup.outputs.SAVE_ARCHIVE }}"
          
          # CrÃ©e une archive tar.gz de tous les fichiers Ã  la racine, 
          # EXCLUT les dossiers systÃ¨me et de travail.
          tar -czvf "$SAVE_ARCHIVE" \
            --exclude .git \
            --exclude .github \
            --exclude saves \
            --exclude dev \
            --exclude "$(basename "$SAVE_ARCHIVE")" \
            .
            
      - name: ğŸ—‘ï¸ Nettoyage de la racine aprÃ¨s compression
        run: |
          # Supprime tous les fichiers Ã  la racine (sauf les dossiers de travail)
          ls -A | grep -v -E "^\.(git|github)$|^saves$|^dev$" | xargs rm -rf
            
      - name: ğŸ“¥ DÃ©placement des fichiers de dev vers la racine
        run: |
          # Copie tout le contenu du dossier 'dev' vers la racine du dÃ©pÃ´t
          cp -r dev/* .

      - name: ğŸ’¾ Commit et Push des changements
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Ajoute tous les changements (sauvegardes, nouveaux fichiers)
          git add .
          
          if git diff --staged --quiet; then
            echo "Pas de changements Ã  commiter."
          else
            git commit -m "ğŸ¤– Auto-dÃ©ploiement: Mise Ã  jour depuis 'dev' et sauvegarde"
            git push
          fi
          
      - name: ğŸš€ DÃ©ploiement Final du Site Statique
        # Cette action va explicitement dire Ã  GitHub de mettre Ã  jour les Pages
        uses: actions/deploy-pages@v4 
        # C'est l'action standard et recommandÃ©e pour le dÃ©ploiement de Pages.
        
        # Le 'needs: commit' assure que l'action ne se lance que si la restauration a eu lieu.
        with:
          # Note: Nous ne spÃ©cifions pas de chemin 'source' ou 'artifact' car l'action 
          # est configurÃ©e pour prendre le contenu de la branche 'main' (ou master) 
          # si l'option 'source' est dÃ©finie sur 'main' dans les paramÃ¨tres de Pages.
          # L'action utilise le jeton de Pages pour dÃ©clencher la mise Ã  jour.
          pass-metadata: true 
